var newsFeedCount=0,address=new Array,done=!1,ClientGeoLocation=null,HarmonyInterop={isInitialized:!1,fieldSelected:"",categorySelected:"",tableSelected:"",AliasType:[],AliasValue:[],typingInterval:!1,searchInterval:!1,currentPostBeatAttachment:[],currentPostBeatFileAttachment:[],currentPostBeatImageAttachment:[],currentPostBeatPDFAttachment:[],textCompleteSearchCache:{},raiseCustomEvent:function(t,a){try{var e=new CustomEvent(t,{detail:a});window.dispatchEvent(e)}catch(e){try{var r=document.createEvent("CustomEvent");r.initCustomEvent(t,!1,!1,a),window.dispatchEvent(r)}catch(e){throw e}}},bindAllWidgets:function(){sysproInterop.harmonyEnabled&&$.each($(".harmony-widget"),function(e){console.log("harmony-widget: "+e),HarmonyInterop.bindWidget($(this))})},bindWidget:function(r,e){try{if(!r)return;console.log("00 bindWidget"+r);var n=r.data("controllername")+"/"+r.data("harmonywidgetname");"AddBeat"===r.data("harmonywidgetname")&&HarmonyInterop.initializeAutoComplete(r,"");var t={},a=r.data("parameters");a&&(t=JSON.parse(a)),sysproInterop.callHarmonyService("GET",n,t,function(e){try{var t=JSON.parse(e);if(console.log("callHarmonyService-"+r.data("harmonywidgetname")+"-"+e),HarmonyInterop.searchInterval=!1,t.ErrorMessage)SYSPRO_VB.showErrorMessage(t.ErrorMessage,"Error Calling "+n);else if("Trending/GetTrendingItems"==n||"Trending/GetTrendingItemsForFollowItem"==n)HarmonyTrendingChart.bindTrendingDrillDown(),HarmonyTrendingChart.renderChartInDiv(r,t,0);else{if("NewsFeeds/Beats"==n){$.each(t.Beats,function(e){this.Feed=ProcessFeedHtml(this.Feed,this.FollowItems)}),$(".ShowMoreNewsFeeds").remove();e=kendo.template($("#Harmony-ShowMore-Template").html())(t);r.append(e)}else"NewsFeeds/WhatYouMissed"==n&&$.each(t.MissedCarousel.CarouselPage.Beats,function(e){this.Feed=ProcessFeedHtml(this.Feed,this.FollowItems)});var a=kendo.observable(t);kendo.bind(r,a),"Filter/GetFilter"==n&&queryLayoutUIHelpers.initializeViewOnly()}}catch(e){SYSPRO_VB.showErrorMessage(e.message,"Error parsing Harmony Service output for "+r.data("harmonywidgetname"))}},function(e){SYSPRO_VB.showErrorMessage(e.ErrorMessage,"Error calling Harmony Service for "+r.data("harmonywidgetname"))}),$(".harmony-widget-floating-refresh",r).off("click"),$(".harmony-widget-floating-refresh",r).on("click",function(e){HarmonyInterop.bindWidget($(this).closest(".harmony-widget"))}),HarmonyInterop.subscribeToComponent(r)}catch(e){console.log(e.message)}},DateFormat:function(e){return kendo.toString(e,"yyyy-MM-dd HH:mm:ss.ffffff zzzzz").substring(0,"yyyy-MM-dd HH:mm:ss.ffffff zzzzz".length)},PostFilter:function(r,e){try{var n=n="Filter/PostXmlFilterData";sysproInterop.callHarmonyService("POST",n,e,function(e){try{var t=JSON.parse(e);if(t.ErrorMessage)SYSPRO_VB.showErrorMessage(t.ErrorMessage,"Error Calling "+n);else{$(".hrm-filtered-section").removeClass("hide"),$(".hrm-filtered-section").addClass("show"),$.each(t.FilterData[0].HrmFilteredList,function(e){this.BeatText=ProcessFeedHtml(this.BeatText,this.ReturnedItems)});var a=kendo.observable(t);kendo.bind(r,a),queryLayoutUIHelpers.initializeViewOnly()}}catch(e){SYSPRO_VB.showErrorMessage(e.message,"Error Calling Harmony PostFilter")}})}catch(e){SYSPRO_VB.showErrorMessage(e.message,"Error Calling Harmony PostFilter")}},PostBeat:function(r,n,o){try{var l="",s="";if(address=new Array,navigator.geolocation)try{t()}catch(e){t()}else t();function t(){var e=$(".harmony-beat-entry-postbutton",r.closest(".harmony-beat-entry-parent")).data("beatparentid");e=e||"",HarmonyInterop.currentPostBeatAttachment=HarmonyInterop.currentPostBeatFileAttachment.concat(HarmonyInterop.currentPostBeatImageAttachment,HarmonyInterop.currentPostBeatPDFAttachment);var t={Message:n,PostDateTime:HarmonyInterop.DateFormat(new Date),ParentId:e,FollowItems:o,Attachments:HarmonyInterop.currentPostBeatAttachment,GeoLocation:l,HumanReadableLocation:s},a=a="Beats/AddBeat";sysproInterop.callHarmonyService("POST",a,t,function(e){try{if(selectedItems=[],taggedWords=[],finalList=[],replacementsMade=[],r.html(""),HarmonyInterop.currentPostBeatAttachment){4==HarmonyInterop.currentPostBeatAttachment.length&&$(".harmony-add-attachment-container").removeClass("hide"),HarmonyInterop.currentPostBeatAttachment=[],HarmonyInterop.currentPostBeatFileAttachment=[],HarmonyInterop.currentPostBeatImageAttachment=[],HarmonyInterop.currentPostBeatPDFAttachment=[],$(".harmony-attachment-count").text("0 of 4");r.find(".harmony-added-file");$(".harmony-added-file").remove(),$(".harmony-added-image").remove(),$(".harmony-added-pdf").remove(),$(".harmony-file-attach").addClass("text-muted"),$(".harmony-file-attach").removeClass("sys-fg-twitter"),$(".harmony-image-attach").addClass("text-muted"),$(".harmony-image-attach").removeClass("sys-fg-twitter"),$(".harmony-pdf-attach").addClass("text-muted"),$(".harmony-pdf-attach").removeClass("sys-fg-twitter"),$(".image-attachment").removeClass("disable-mouse-events"),$(".file-attachment").removeClass("disable-mouse-events"),$(".pdf-attachment").removeClass("disable-mouse-events"),$(".file-attachment-list").addClass("hide"),$(".image-attachment-list").addClass("hide"),$(".pdf-attachment-list").addClass("hide"),$(".file-attachment-list").removeClass("show"),$(".image-attachment-list").removeClass("show"),$(".pdf-attachment-list").removeClass("show")}$("#HarmonyReplies")||$("#HarmonyReplies").remove(),HarmonyInterop.bindAllWidgets()}catch(e){SYSPRO_VB.showErrorMessage(e.message,"Error Calling Harmony Service")}},function(e){SYSPRO_VB.showErrorMessage(e.ErrorMessage,"Error Calling Harmony Service")})}}catch(e){SYSPRO_VB.showErrorMessage(e.ErrorMessage,"Error Calling Harmony PostBeat")}},CloseReplyToBeat:function(){try{return $(".HarmonyReplies").remove(),$(".Harmony-Replies-Follow-Items").remove(),$(".HrmBeatItem").find(".hrm-key-field-template-reply").removeClass("hrm-key-field-template-reply"),$(".HrmBeatItem").show(),void(0<$("#feed").length&&$("#feed").carousel("cycle"))}catch(e){SYSPRO_VB.showErrorMessage(e.ErrorMessage,"Error Close Reply to Beat")}},FollowFields:function(){try{var a=a="Follow/FollowField";sysproInterop.callHarmonyService("GET",a,{KeyTable:"InvMaster",KeyColumn:"StockCode",KeyValue:"A100",FollowField:"StockCode"},function(e){try{var t=JSON.parse(e);t.ErrorMessage&&SYSPRO_VB.showErrorMessage(t.ErrorMessage,"Error Calling "+a)}catch(e){SYSPRO_VB.showErrorMessage(e.message,"Error Calling Harmony Service")}},function(e){SYSPRO_VB.showErrorMessage(e.ErrorMessage,"Error Calling Harmony Service")})}catch(e){}},IsUserFollowing:function(){try{var a=a="Follow/IsUserFollowing";sysproInterop.callHarmonyService("GET",a,{KeyTable:"InvMaster",KeyColumn:"StockCode",KeyValue:"A100",FollowField:"StockCode"},function(e){try{var t=JSON.parse(e);t.ErrorMessage&&SYSPRO_VB.showErrorMessage(t.ErrorMessage,"Error Calling "+a)}catch(e){SYSPRO_VB.showErrorMessage(e.message,"Error Calling Harmony Service")}},function(e){SYSPRO_VB.showErrorMessage(e.ErrorMessage,"Error Calling Harmony Service")})}catch(e){}},AdmireBeat:function(e,t){try{var a=a="Beats/AdmireBeat",r={BeatId:e,UserId:t};sysproInterop.callHarmonyService("GET",a,r,function(e){try{var t=JSON.parse(e);t.ErrorMessage&&SYSPRO_VB.showErrorMessage(t.ErrorMessage,"Error Calling "+a)}catch(e){SYSPRO_VB.showErrorMessage(e.message,"Error Calling Harmony Service")}},function(e){SYSPRO_VB.showErrorMessage(e.ErrorMessage,"Error Calling Harmony Service")})}catch(e){}},Rebeat:function(e){try{var a=a="Beats/ReBeat",t={BeatId:e};sysproInterop.callHarmonyService("GET",a,t,function(e){try{var t=JSON.parse(e);t.ErrorMessage&&SYSPRO_VB.showErrorMessage(t.ErrorMessage,"Error Calling "+a)}catch(e){SYSPRO_VB.showErrorMessage(e.message,"Error Calling Harmony Service")}},function(e){SYSPRO_VB.showErrorMessage(e.ErrorMessage,"Error Calling Harmony Service")})}catch(e){}},UnAdmireBeat:function(e,t){try{var a=a="Beats/UnAdmireBeat",r={BeatId:e,UserId:t};sysproInterop.callHarmonyService("GET",a,r,function(e){try{var t=JSON.parse(e);t.ErrorMessage&&SYSPRO_VB.showErrorMessage(t.ErrorMessage,"Error Calling "+a)}catch(e){SYSPRO_VB.showErrorMessage(e.message,"Error unadmiring beat")}},function(e){SYSPRO_VB.showErrorMessage(e.ErrorMessage,"Error unadmiring beat")})}catch(e){}},UploadImage:function(e){try{var a="Images/UpLoadImage";sysproInterop.callHarmonyService("POST",a,e,function(e){try{var t=JSON.parse(e);t.ErrorMessage?SYSPRO_VB.showErrorMessage(t.ErrorMessage,"Error Calling "+a):($("#ProfileImage").attr("src",t.ProfilePicture),$("#ProfileCard").toggle().toggle(),console.log("UploadImage - Performed Profile Bind"))}catch(e){SYSPRO_VB.showErrorMessage(e.message,"Error Calling Harmony Service")}},function(e){SYSPRO_VB.showErrorMessage(e.ErrorMessage,"Error Calling Harmony Service")})}catch(e){}},UploadAttachment:function(e){try{var a="Beats/UploadAttachment";sysproInterop.callHarmonyService("POST",a,e,function(e){try{var t=JSON.parse(e);t.ErrorMessage?SYSPRO_VB.showErrorMessage(t.ErrorMessage,"Error Calling "+a):console.log("UploadImage - Performed Profile Bind")}catch(e){SYSPRO_VB.showErrorMessage(e.message,"Error Uploading Attachment")}},function(e){SYSPRO_VB.showErrorMessage(e.ErrorMessage,"Error Uploading Attachment")})}catch(e){SYSPRO_VB.showErrorMessage(e.ErrorMessage,"Error Uploading Attachment")}},BrowseImage:function(){var e=sysproInterop.selectImage();e||HarmonyInterop.UploadImage(e)},FollowAlias:function(){try{sysproInterop.callHarmonyService("GET","Follow/FollowField",{KeyTable:"InvMaster",KeyColumn:"StockCode",KeyValue:"A100",FollowField:"StockCode",Context:""},function(e){try{var t=JSON.parse(e);t.ErrorMessage&&SYSPRO_VB.showErrorMessage(t.ErrorMessage,"Error Calling "+ControllerName)}catch(e){SYSPRO_VB.showErrorMessage(e.message,"Error unadmiring beat")}},function(e){SYSPRO_VB.showErrorMessage(e.ErrorMessage,"Error unadmiring beat")})}catch(e){}},ShowMoreBeats:function(e){try{var t={FollowItemId:e.parentNode.attributes["data-follow"].nodeValue,FriendId:e.parentNode.attributes["data-friends"].nodeValue,PopularId:e.parentNode.attributes["data-popular"].nodeValue,LooseId:e.parentNode.attributes["data-loose"].nodeValue},s="NewsFeeds/ShowMoreBeats";sysproInterop.callHarmonyService("GET",s,t,function(e){try{var t=JSON.parse(e);$.each(t.Beats,function(e){this.Feed=ProcessFeedHtml(this.Feed,this.FollowItems)});kendo.observable(t);var a=kendo.template($("#beats_template").html()),r=$("#Beat");for(var n in t.Beats){var o=a(t.Beats[n]);$(".Show-More-Beats-Here").append(o)}$(".ShowMoreNewsFeeds").remove();r=$("#Beats");var l=kendo.template($("#Harmony-ShowMore-Template").html())(t);r.append(l),t.ErrorMessage&&SYSPRO_VB.showErrorMessage(t.ErrorMessage,"Error Calling "+s)}catch(e){SYSPRO_VB.showErrorMessage(e.message,"Error unadmiring beat")}},function(e){SYSPRO_VB.showErrorMessage(e.ErrorMessage,"Error unadmiring beat")})}catch(e){SYSPRO_VB.showErrorMessage("Error on Show More Beats : "+e.message)}},InitializeAttachments:function(){},BindHarmonyNewsFeed:function(e){try{$(".carousel").carousel({interval:4e3}),$.each(e.InAndAroundSYSPRO.Pages,function(e){this.feed=this.feed.replace(/#[a-z0-9A-Z]+/g,'<span class="text-primary">$&</span>')}),kendo.bind($("#NewsAlert"),e)}catch(e){SYSPRO_VB.showErrorMessage(error.ErrorMessage,"Error Binding Harmony NewsFeed")}},initializeAutoComplete:function(r,e){try{var o;if($(".harmony-beat-entry-postbutton",r).off("click"),$(".harmony-beat-entry-postbutton",r).on("click",function(){PostBeatClicked($(".harmony-beat-entry",r)),$(".harmony-beat-entry-preview").show(),$(".harmony-beat-entry-action").toggleClass("hide"),$(".harmony-beat-entry-action").toggleClass("show"),0<$("#feed").length&&$("#feed").carousel("cycle")}),$(".harmony-beat-entry-postbutton",r).data("beatparentid",e),"true"!==$(".harmony-beat-entry",r).data("textcompleteinitialized")){$(".harmony-beat-entry",r).textcomplete([{match:/\B#(\w{1,})$/,search:function(a,r){console.log("search performed: "+a);HarmonyInterop.tableSelected="",HarmonyInterop.categorySelected="",HarmonyInterop.fieldSelected="",HarmonyInterop.AliasType=[],HarmonyInterop.AliasValue=[],o=a,HarmonyInterop.typingInterval||(HarmonyInterop.typingInterval=!0,console.log("search GetRootItems Initialized - "+a+" - "+o),sysproInterop.callHarmonyService("GET","AutoComplete/GetRootItems",{QueryValue:a},function(e){try{HarmonyInterop.typingInterval=!1;var t=JSON.parse(e);console.log("search GetRootItems Completed - "+a+" - results count - "+t.length),r(t)}catch(e){HarmonyInterop.typingInterval=!1,SYSPRO_VB.showErrorMessage(e.message,"Error Calling Harmony Service"),r([])}},function(e){HarmonyInterop.typingInterval=!1,SYSPRO_VB.showErrorMessage(e.ErrorMessage,"Error Calling Harmony Service"),r([])}))},index:1,template:function(e){return"History"===e.Type?Alias_Template(e):HistoryNew_Template(e)},replace:function(e){return HarmonyInterop.AliasType.push(e),"#"+e.DataField1}},{match:/(\B#\w*\b\.*(\S[^\.\s]*))$/,search:function(e,r){var t=e.indexOf("#")+1,a=e.indexOf(".");o=e,HarmonyInterop.categorySelected=e.substring(t,a),HarmonyInterop.fieldSelected="",HarmonyInterop.AliasValue=[];var n=e.substr(e.indexOf(".")+1);n=n||"",HarmonyInterop.typingInterval||(HarmonyInterop.typingInterval=!0,console.log("search GetDataList initialized - "+n+" - "+HarmonyInterop.categorySelected+" - "+e),sysproInterop.callHarmonyService("GET","AutoComplete/GetDataList",{QueryValue:n,RootName:HarmonyInterop.categorySelected},function(e){try{HarmonyInterop.typingInterval=!1;var t=JSON.parse(e);if(0<t.length&&(HarmonyInterop.tableSelected=t[0].DataField3,HarmonyInterop.categorySelected=t[0].Type,0==HarmonyInterop.AliasType.length)){var a={DataField1:HarmonyInterop.categorySelected,DataField2:HarmonyInterop.tableSelected,DataField3:"",Key:HarmonyInterop.categorySelected,Type:"Category"};HarmonyInterop.AliasType.push(a)}r(t)}catch(e){HarmonyInterop.typingInterval=!1,SYSPRO_VB.showErrorMessage(e.message,"Error Calling GetDataList"),r([])}},function(e){HarmonyInterop.typingInterval=!1,SYSPRO_VB.showErrorMessage(e.ErrorMessage,"Error Calling GetDataList"),r([])}))},index:1,template:function(e){return Category_Template(e)},replace:function(e){return HarmonyInterop.AliasValue.push(e),AliasFullValue=e,HarmonyInterop.fieldSelected=e.DataField1,"#"+HarmonyInterop.getAlias(e.Type,e.DataField1,e.Key,"")}},{match:/(\B#\w*\b\..*\.\w*)$/,search:function(e,n){e.indexOf("#"),e.indexOf(".");var t=(o=e).indexOf(".")+1,a=(e.substring(t)+1).indexOf(".")+t;""==HarmonyInterop.fieldSelected&&(HarmonyInterop.fieldSelected=e.substring(t,a));var r=e.substring(a+1);console.log("search  GetDataFields initialized - "+r+" - "+HarmonyInterop.tableSelected+" - "+HarmonyInterop.fieldSelected+" - "+e),null!=HarmonyInterop.tableSelected&&""!=HarmonyInterop.tableSelected&&(HarmonyInterop.typingInterval||(HarmonyInterop.typingInterval=!0,sysproInterop.callHarmonyService("GET","AutoComplete/GetDataFields",{QueryValue:r,RootName:HarmonyInterop.tableSelected,KeyColumnName:HarmonyInterop.categorySelected,KeyFieldValue:HarmonyInterop.fieldSelected},function(e){try{HarmonyInterop.typingInterval=!1;var t=JSON.parse(e);if(0<t.length){var a=t[0].Type;if(HarmonyInterop.fieldSelected=t[0].DataField1,0==HarmonyInterop.AliasValue.length){var r=[{DataField1:HarmonyInterop.fieldSelected,DataField2:"",DataField3:HarmonyInterop.tableSelected,Key:"",Type:a.toString()}];HarmonyInterop.AliasValue.push(r)}}n(t)}catch(e){HarmonyInterop.typingInterval=!1,SYSPRO_VB.showErrorMessage(e.message,"Error Calling Harmony Service"),n([])}},function(e){HarmonyInterop.typingInterval=!1,SYSPRO_VB.showErrorMessage(e.ErrorMessage,"Error Calling Harmony Service"),n([])})))},index:1,template:function(e){return"<small > "+e.Type+" : </small><small> "+e.Key+"</small>"},replace:function(e){var t=UpdateSelectionList(e,$(".harmony-beat-entry",r)),a=GenerateHtmlBlockFromHashAlias(t,HarmonyInterop.categorySelected,HarmonyInterop.fieldSelected,e.Type,e.Key.replace(/[^\w]/g,"_"),!0,"",selectedItems.length-1);return AddReplacementsMadeItem("#"+t,a),a}},{match:/\B@(\w*)$/,search:function(e,a){HarmonyInterop.tableSelected="",HarmonyInterop.categorySelected="",HarmonyInterop.fieldSelected="",HarmonyInterop.AliasType=[],HarmonyInterop.AliasValue=[],HarmonyInterop.typingInterval||(HarmonyInterop.typingInterval=!0,sysproInterop.callHarmonyService("GET","AutoComplete/GetUserList",{QueryValue:e},function(e){try{HarmonyInterop.typingInterval=!1;var t=JSON.parse(e);a(t)}catch(e){HarmonyInterop.typingInterval=!1,SYSPRO_VB.showErrorMessage(e.message,"Error Calling Harmony Service"),a([])}},function(e){HarmonyInterop.typingInterval=!1,SYSPRO_VB.showErrorMessage(e.ErrorMessage,"Error Calling Harmony Service"),a([])}))},index:1,template:function(e){return"History"===e.Type?User_Alias_Template(e):user_Template(e)},replace:function(e){if(console.log("user: "+JSON.stringify(e)),e.Key){var t=GenerateHtmlBlockFromHashAlias((AliasUser=e).Key,e.Key,null,null,null,!0,null,selectedItems.length);return AddReplacementsMadeItem("@"+e.Key,t),AddSelectedItem($(".harmony-beat-entry",r),"@"+e.Key,"HrmUser","UserId","","","",""),t}}}]),"SYSPRORehostedBrowser"===callLayerInterop.interopType&&$(".harmony-beat-entry",r).on("DOMCharacterDataModified",function(){console.log("sysbeat input");var e=$(this).data("textComplete");setTimeout(function(){e.trigger()},100)});var t=null;0<$(".harmony-beat-entry",r).length&&(t=$(".harmony-beat-entry",r)[0]),t&&(t.addEventListener("input",function(){ProcessMissingTags($(".harmony-beat-entry",r))},!1),t.addEventListener("DOMNodeInserted",function(){ProcessMissingTags($(".harmony-beat-entry",r))},!1),t.addEventListener("DOMNodeRemoved",function(){ProcessMissingTags($(".harmony-beat-entry",r))},!1),t.addEventListener("DOMCharacterDataModified",function(){ProcessMissingTags($(".harmony-beat-entry",r))},!1)),$(".harmony-beat-entry",r).data("textcompleteinitialized","true")}}catch(e){SYSPRO_VB.showErrorMessage("Initailize Beat Entry - "+e.message)}},seeMore:function(e){try{var t=$(e).closest(".harmony-widget"),a=$(t).find(".harmony-search-text").val();if(t.data("parameters")){var r=JSON.parse(t.data("parameters")).seemore;void 0!==r?(r=(parseFloat(r)+1).toString(),t.data("parameters",'{ "seemore": "'+r+'",  "search":"'+a+'" }')):t.data("parameters",'{ "seemore": "2",  "search":"'+a+'" }')}else t.data("parameters",'{ "seemore": "2",  "search":"'+a+'" }');$(e).hasClass("hrm-see-more-beats")?HarmonyInterop.postFilterNewsFeeds(e):HarmonyInterop.bindWidget(t)}catch(e){SYSPRO_VB.showErrorMessage("Error returned when increasing items : "+e.message)}},seeMoreFilter:function(e){console.log("seeMoreFilter");try{var t,a=$(e).closest(".harmony-widget");if($(e).hasClass("hrm-see-more-follow-items")?t="followitems":$(e).hasClass("hrm-see-more-users")&&(t="users"),a.data("parameters")){var r=JSON.parse(a.data("parameters")),n=r.seeMoreUsers,o=r.seeMoreFollowItems;void 0!==n&&void 0!==o?("followitems"==t?o=(parseFloat(o)+1).toString():n=(parseFloat(n)+1).toString(),a.data("parameters",'{ "seeMoreUsers": "'+n+'" ,"seeMoreFollowItems": "'+o+' "}')):a.data("parameters",'{ "seeMoreUsers": "1", "seeMoreFollowItems": "1" }')}else{if("followitems"!=t)return a.data("parameters",'{ "seeMoreUsers": "2", "seeMoreFollowItems": "1"}');a.data("parameters",'{ "seeMoreUsers": "1", "seeMoreFollowItems": "2"}')}HarmonyInterop.bindWidget(a)}catch(e){SYSPRO_VB.showErrorMessage("Error returned when increasing items : "+e.message)}},addFollowItem:function(e){try{var a=$(e).closest(".follow-item"),t=($(e).closest(".harmony-widget"),a.html(),{FollowItemId:$(a).find(".follow-item-id").data("followitemid")}),r=r="Trending/PostHrmUserFollowItem";sysproInterop.callHarmonyService("GET",r,t,function(e){try{var t=a.find(".follow-item-added");t.removeClass("btn-follow"),t.removeClass("text-muted"),t.addClass("btn-following"),t.addClass("sys-bg-twitter"),t.css("color","white"),t.html("Following"),HarmonyInterop.bindAllWidgets()}catch(e){SYSPRO_VB.showErrorMessage("Unable to add selection : "+e.message)}})}catch(e){SYSPRO_VB.showErrorMessage("Unable to add selection : "+e.message)}},deleteFollowItem:function(e){try{var a=$(e).closest(".follow-item"),t=($(e).closest(".harmony-widget"),a.html(),{FollowItemId:$(a).find(".follow-item-id").data("followitemid")}),r=r="Trending/DeleteHrmUserFollowItem";sysproInterop.callHarmonyService("GET",r,t,function(e){try{var t=a.find(".follow-item-added");t.addClass("btn-follow"),t.addClass("text-muted"),t.removeClass("btn-following"),t.removeClass("sys-bg-twitter"),t.css("color","#888888"),t.html("Follow"),HarmonyInterop.bindAllWidgets()}catch(e){SYSPRO_VB.showErrorMessage("Unable to remove follow item : "+e.message)}})}catch(e){SYSPRO_VB.showErrorMessage("Unable to remove follow item  : "+e.message)}},OpenAttachment:function(e){try{var t=e.attributes["data-HrmAttachmentUri"].nodeValue,a=e.attributes["data-MediaFileName"].nodeValue;sysproInterop.openFile(function(){},function(e){},t,a)}catch(e){sysproInterop.showErrorMessage(e.message)}},uploadProfilePicture:function(){sysproInterop.selectImage(function(e){HarmonyInterop.UploadImage(e),$("#ProfileImage").attr("src","")})},suggestiveBeatSelection:function(e){console.log("suggestiveBeatSelection"),$(".harmony-beat-suggestion").toggleClass("hide"),$(".harmony-beat-suggestion").toggleClass("show"),$(".harmony-light-switch").toggleClass("sys-fg-twitter");$(e).closest(".harmony-suggestion-selection");var t=$(".active .harmony-suggestive-text").html(),a=$(".harmony-beat-entry").html();$(".harmony-beat-entry").focus().html(a+t)},uploadFileAttachment:function(e){var l=$(e).closest(".harmony-attachments");sysproInterop.selectFile(function(e){console.log("uploadFileAttachment e: "+e);var t=1;if(0<HarmonyInterop.currentPostBeatFileAttachment.length){for(var a=0;a<HarmonyInterop.currentPostBeatFileAttachment.length;a++)HarmonyInterop.currentPostBeatFileAttachment[a].index>t&&(t=HarmonyInterop.currentPostBeatFileAttachment[a].index);t++,e.index=t,HarmonyInterop.currentPostBeatFileAttachment.push(e)}else e.index=t,HarmonyInterop.currentPostBeatFileAttachment.push(e);1===HarmonyInterop.currentPostBeatFileAttachment.length?($(".harmony-file-attach").addClass("sys-fg-twitter"),$(".file-attachment").toggleClass("disable-mouse-events")):0===HarmonyInterop.currentPostBeatFileAttachment.length?($(".harmony-file-attach").addClass("text-muted"),$(".harmony-file-attach").removeClass("sys-fg-twitter")):4===HarmonyInterop.currentPostBeatFileAttachment.length&&$(".harmony-add-attachment-container").addClass("hide");var r=l.find(".harmony-attachment-count");r.addClass("sys-fg-twitter text-center"),r.text(HarmonyInterop.currentPostBeatFileAttachment.length+" of 4");var n=e.FilePath.split("\\").pop(),o="data:image/png;base64,"+e.FileBase64;l.find(".harmony-add-file-container").append("<div class='harmony-added-file'><a href='#' class='sys-mg-r-10 thumbnail harmony-attachment-container' style='width:100px !important' ><img src='"+o+"' style='max-width:80%; max-height: 80%;; position:relative;' ><i class='harmony-attachment-container-close material-icons ' style='position:absolute; top:4%; margin-left:15%;'>close</i><div class='text-muted  sys-txt-sm sys-pd-t-5'>"+n+"</div><div class='harmony-file-attachment-index' style='display:none'>"+t+"</div></a></div>")},null,"AllFiles")},uploadImageAttachment:function(e){var l=$(e).closest(".harmony-attachments");sysproInterop.selectFile(function(e){var t=1;if(0<HarmonyInterop.currentPostBeatImageAttachment.length){for(var a=0;a<HarmonyInterop.currentPostBeatImageAttachment.length;a++)HarmonyInterop.currentPostBeatImageAttachment[a].index>t&&(t=HarmonyInterop.currentPostBeatImageAttachment[a].index);t++,e.index=t,HarmonyInterop.currentPostBeatImageAttachment.push(e)}else e.index=t,HarmonyInterop.currentPostBeatImageAttachment.push(e);1===HarmonyInterop.currentPostBeatImageAttachment.length?($(".harmony-image-attach").addClass("sys-fg-twitter"),$(".image-attachment").toggleClass("disable-mouse-events")):0===HarmonyInterop.currentPostBeatImageAttachment.length?($(".harmony-image-attach").addClass("text-muted"),$(".harmony-image-attach").removeClass("sys-fg-twitter")):4===HarmonyInterop.currentPostBeatImageAttachment.length&&$(".harmony-add-attachment-container").addClass("hide");var r=l.find(".harmony-attachment-count");r.addClass("sys-fg-twitter text-center"),r.text(HarmonyInterop.currentPostBeatImageAttachment.length+" of 4");HarmonyInterop.currentPostBeatImageAttachment.length;var n=e.FilePath.split("\\").pop(),o="data:image/png;base64,"+e.FileBase64;l.find(".harmony-add-image-container").append("<div class='harmony-added-image'><a href='#' class='thumbnail sys-mg-r-10 harmony-attachment-container' style='width:100px !important'><img src='"+o+"'  style='max-width:80%; max-height: 80%;; position:relative;' ><i class='harmony-attachment-container-close material-icons ' style='position:absolute; top:4%; margin-left:15%;'>close</i><div class='text-muted sys-txt-sm sys-pd-t-5'>"+n+"</div><div class='harmony-image-attachment-index' style='display:none'>"+t+"</div></a></div>")},null,"Images")},uploadPDFAttachment:function(e){var l=$(e).closest(".harmony-attachments");sysproInterop.selectFile(function(e){var t=1;if(0<HarmonyInterop.currentPostBeatPDFAttachment.length){for(var a=0;a<HarmonyInterop.currentPostBeatPDFAttachment.length;a++)HarmonyInterop.currentPostBeatPDFAttachment[a].index>t&&(t=HarmonyInterop.currentPostBeatPDFAttachment[a].index);t++,e.index=t,HarmonyInterop.currentPostBeatPDFAttachment.push(e)}else e.index=t,HarmonyInterop.currentPostBeatPDFAttachment.push(e);1===HarmonyInterop.currentPostBeatPDFAttachment.length?($(".harmony-pdf-attach").addClass("sys-fg-twitter"),$(".pdf-attachment").toggleClass("disable-mouse-events")):0===HarmonyInterop.currentPostBeatPDFAttachment.length?($(".harmony-pdf-attach").addClass("text-muted"),$(".harmony-pdf-attach").removeClass("sys-fg-twitter")):4===HarmonyInterop.currentPostBeatPDFAttachment.length&&$(".harmony-add-attachment-container").addClass("hide");var r=l.find(".harmony-attachment-count");r.addClass("sys-fg-twitter text-center"),r.text(HarmonyInterop.currentPostBeatPDFAttachment.length+" of 4");HarmonyInterop.currentPostBeatPDFAttachment.length;var n=e.FilePath.split("\\").pop(),o="data:image/png;base64,"+e.FileBase64;l.find(".harmony-add-pdf-container").append("<div class='harmony-added-pdf'><a href='#' class='thumbnail sys-mg-r-10 harmony-attachment-container' style='width:100px !important'><img src='"+o+"'  style='max-width:80%; max-height: 80%;; position:relative;' ><i class='harmony-attachment-container-close material-icons ' style='position:absolute; top:4%; margin-left:15%;' >close</i><div class='text-muted sys-txt-sm sys-pd-t-5'>"+n+"</div><div class='harmony-pdf-attachment-index' style='display:none'>"+t+"</div></a></div>")},null,"Documents")},removeFileAttachment:function(e){console.log("removeFileAttachment");for(var t=$(e).closest(".harmony-added-file"),a=t.find(".harmony-file-attachment-index").text(),r=0;r<HarmonyInterop.currentPostBeatFileAttachment.length;r++)HarmonyInterop.currentPostBeatFileAttachment[r].index==a&&(HarmonyInterop.currentPostBeatFileAttachment.splice(r,1),$(".harmony-attachment-count").text(HarmonyInterop.currentPostBeatFileAttachment.length+" of 4"),t.remove(".harmony-added-file"),0===HarmonyInterop.currentPostBeatFileAttachment.length?($(".harmony-file-attach").addClass("text-muted"),$(".harmony-file-attach").removeClass("sys-fg-twitter"),$(".file-attachment-list").toggleClass("hide"),$(".file-attachment-list").toggleClass("show"),$(".image-attachment").toggleClass("disable-mouse-events"),$(".pdf-attachment").toggleClass("disable-mouse-events"),$(".file-attachment").toggleClass("disable-mouse-events")):HarmonyInterop.currentPostBeatFileAttachment.length<4&&$(".harmony-add-attachment-container").removeClass("hide"))},removeImageAttachment:function(e){for(var t=$(e).closest(".harmony-added-image"),a=t.find(".harmony-image-attachment-index").text(),r=0;r<HarmonyInterop.currentPostBeatImageAttachment.length;r++)HarmonyInterop.currentPostBeatImageAttachment[r].index==a&&(HarmonyInterop.currentPostBeatImageAttachment.splice(r,1),$(".harmony-attachment-count").text(HarmonyInterop.currentPostBeatImageAttachment.length+" of 4"),t.remove(".harmony-added-image"),0===HarmonyInterop.currentPostBeatImageAttachment.length?($(".harmony-image-attach").addClass("text-muted"),$(".harmony-image-attach").removeClass("sys-fg-twitter"),$(".image-attachment-list").toggleClass("hide"),$(".image-attachment-list").toggleClass("show"),$(".file-attachment").toggleClass("disable-mouse-events"),$(".pdf-attachment").toggleClass("disable-mouse-events"),$(".image-attachment").toggleClass("disable-mouse-events")):HarmonyInterop.currentPostBeatImageAttachment.length<4&&$(".harmony-add-attachment-container").removeClass("hide"))},removePDFAttachment:function(e){for(var t=$(e).closest(".harmony-added-pdf"),a=t.find(".harmony-pdf-attachment-index").text(),r=0;r<HarmonyInterop.currentPostBeatPDFAttachment.length;r++)HarmonyInterop.currentPostBeatPDFAttachment[r].index==a&&(HarmonyInterop.currentPostBeatPDFAttachment.splice(r,1),$(".harmony-attachment-count").text(HarmonyInterop.currentPostBeatPDFAttachment.length+" of 4"),t.remove(".harmony-added-pdf"),0===HarmonyInterop.currentPostBeatPDFAttachment.length?($(".harmony-pdf-attach").addClass("text-muted"),$(".harmony-pdf-attach").removeClass("sys-fg-twitter"),$(".pdf-attachment-list").toggleClass("hide"),$(".pdf-attachment-list").toggleClass("show"),$(".image-attachment").toggleClass("disable-mouse-events"),$(".file-attachment").toggleClass("disable-mouse-events"),$(".pdf-attachment").toggleClass("disable-mouse-events")):HarmonyInterop.currentPostBeatPDFAttachment.length<4&&$(".harmony-add-attachment-container").removeClass("hide"))},removeTextCompleteWord:function(e){console.log("removeTextCompleteWord");var t=$(e).closest(".harmony-text-complete"),a=t.data("identifier");selectedItems.splice(a,1),replacementsMade.splice(a,1),t.remove(".harmony-text-complete")},profileSelectionClicked:function(e){console.log("profileBeatsClicked"),0==$(".text-blue-underline").length?1==$(e).closest(".sys-profile-beats").length?($(".sys-profile-beats-list").show(),$(".sys-profile-beats-header").toggleClass("text-blue-underline"),$(".sys-profile-following").toggleClass("disable-mouse-events"),$(".sys-profile-followers").toggleClass("disable-mouse-events")):1==$(e).closest(".sys-profile-following").length?($(".sys-profile-following-list").show(),$(".sys-profile-following-header").toggleClass("text-blue-underline"),$(".sys-profile-beats").toggleClass("disable-mouse-events"),$(".sys-profile-followers").toggleClass("disable-mouse-events")):1==$(e).closest(".sys-profile-followers").length&&($(".sys-profile-followers-list").show(),$(".sys-profile-followers-header").toggleClass("text-blue-underline"),$(".sys-profile-beats").toggleClass("disable-mouse-events"),$(".sys-profile-following").toggleClass("disable-mouse-events")):1==$(e).closest(".sys-profile-beats").length?($(".sys-profile-beats-list").hide(),$(".sys-profile-beats-header").toggleClass("text-blue-underline"),$(".sys-profile-following").toggleClass("disable-mouse-events"),$(".sys-profile-followers").toggleClass("disable-mouse-events")):1==$(e).closest(".sys-profile-following").length?($(".sys-profile-following-list").hide(),$(".sys-profile-following-header").toggleClass("text-blue-underline"),$(".sys-profile-beats").toggleClass("disable-mouse-events"),$(".sys-profile-followers").toggleClass("disable-mouse-events")):1==$(e).closest(".sys-profile-followers").length&&($(".sys-profile-followers-list").hide(),$(".sys-profile-followers-header").toggleClass("text-blue-underline"),$(".sys-profile-beats").toggleClass("disable-mouse-events"),$(".sys-profile-following").toggleClass("disable-mouse-events"))},profileSelectionOverOut:function(e){var t;console.log("profileSelectionOverOut"),0==$(".text-blue-underline").length&&(1==$(e).closest(".sys-profile-beats").length?(t=$(".sys-profile-beats-list"),$(".sys-profile-beats-header").toggleClass("text-underline")):1==$(e).closest(".sys-profile-following").length?(t=$(".sys-profile-following-list"),$(".sys-profile-following-header").toggleClass("text-underline")):1==$(e).closest(".sys-profile-followers").length&&(t=$(".sys-profile-followers-list"),$(".sys-profile-followers-header").toggleClass("text-underline")),$(t).toggleClass("hide"),$(t).toggleClass("show"))},profileDetailOver:function(){$(".sys-profile-detail").toggleClass("hide"),$(".sys-profile-detail").toggleClass("show")},profileDetailOut:function(){$(".sys-profile-detail").toggleClass("hide"),$(".sys-profile-detail").toggleClass("show")},searchItemsList:function(e){try{console.log("searchItemsList");var t=$(e).closest(".harmony-search"),a=$(t).find(".harmony-search-text").val(),r=$(e).closest(".harmony-widget");if(r.data("parameters")){JSON.parse(r.data("parameters"));r.data("parameters",'{ "search":"'+a+'" }')}else{r.data("parameters",'{ "search":"'+a+'" }');JSON.parse(r.data("parameters"))}HarmonyInterop.bindWidget(r)}catch(e){alert("searchFollowItemsList error: "+e.message)}},filterDateRangeSlider:function(e){console.log("Slide :: new slide values are: ");$(this).closest(".harmony-widget"),$(".hrm-filter-date-single").val("")},postFilterNewsFeeds:function(e){try{console.log("postFilterNewsFeeds : "+e);var t=$(e).closest(".harmony-widget"),a=$(t).find(".hrm-main-filter")[0].kendoBindingTarget.source.FilterData[0];a.CreatedDateTime_End=$(".hrm-filter-date-range")[0].getAttribute("data-slider-endvalue"),a.CreatedDateTime_Start=$(".hrm-filter-date-range")[0].getAttribute("data-slider-startvalue"),a.Sentiment_End=$(".avanti-sentiment-slider")[0].getAttribute("data-slider-endvalue"),a.Sentiment_Start=$(".avanti-sentiment-slider")[0].getAttribute("data-slider-startvalue"),a.RebeatCount_End=$(".hrm-filter-rebeat-count")[0].getAttribute("data-slider-endvalue"),a.RebeatCount_Start=$(".hrm-filter-rebeat-count")[0].getAttribute("data-slider-startvalue"),a.AdmiredCount_End=$(".hrm-filter-admire-count")[0].getAttribute("data-slider-endvalue"),a.AdmiredCount_Start=$(".hrm-filter-admire-count")[0].getAttribute("data-slider-startvalue"),a.NrOfAttachments_End=$(".hrm-filter-attachment-count")[0].getAttribute("data-slider-endvalue"),a.NrOfAttachments_Start=$(".hrm-filter-attachment-count")[0].getAttribute("data-slider-startvalue");var r={},n=t.data("parameters");n&&(r=JSON.parse(n)),a.Paging=r.seemore,HarmonyInterop.PostFilter(t,a)}catch(e){alert("postFilterNewsFeeds error: "+e.message)}},subscribeToComponent:function(e){$(".harmony-profile-selectable",e).off("click"),$(".harmony-profile-selectable",e).on("click",function(e){HarmonyInterop.profileSelectionClicked(this)}),$(".harmony-profile-selectable",e).off("mouseleave"),$(".harmony-profile-selectable",e).on("mouseleave",function(e){HarmonyInterop.profileSelectionOverOut(this)}),$(".harmony-profile-selectable",e).off("mouseenter"),$(".harmony-profile-selectable",e).on("mouseenter",function(e){HarmonyInterop.profileSelectionOverOut(this)}),$(".harmony-profile-detail-hover",e).off("mouseleave"),$(".harmony-profile-detail-hover",e).on("mouseleave",function(e){HarmonyInterop.profileDetailOut(this)}),$(".harmony-profile-detail-hover",e).off("mouseenter"),$(".harmony-profile-detail-hover",e).on("mouseenter",function(e){HarmonyInterop.profileDetailOver(this)}),$(".harmony-profile-image-selectable",e).off("click"),$(".harmony-profile-image-selectable",e).on("click",function(e){HarmonyInterop.uploadProfilePicture(this)}),$(e).off("click",".harmony-profile-follower-selectable"),$(e).on("click",".harmony-profile-follower-selectable",function(e){HarmonyInterop.addFollowItem(this)}),$(e).off("click",".harmony-profile-unfollow-selectable"),$(e).on("click",".harmony-profile-unfollow-selectable",function(e){HarmonyInterop.deleteFollowItem(this)}),$(".harmony-see-more",e).off("click"),$(".harmony-see-more",e).on("click",function(e){HarmonyInterop.seeMore(this)}),$(".harmony-beat-entry-preview",e).off("click"),$(".harmony-beat-entry-preview",e).on("click",function(e){$(".harmony-beat-entry-preview").hide(),$(".harmony-beat-entry-action").toggleClass("hide"),$(".harmony-beat-entry-action").toggleClass("show"),$(".harmony-beat-entry").focus()}),$(".harmony-beat-entry-action-close",e).off("click"),$(".harmony-beat-entry-action-close",e).on("click",function(e){$(".harmony-beat-entry-preview").show(),$(".harmony-beat-entry-action").toggleClass("hide"),$(".harmony-beat-entry-action").toggleClass("show")}),$(e).off("click",".harmony-what-to-beat"),$(e).on("click",".harmony-what-to-beat",function(e){$(".harmony-beat-suggestion").toggleClass("hide"),$(".harmony-beat-suggestion").toggleClass("show"),$(".harmony-light-switch").toggleClass("sys-fg-twitter")}),$(e).off("click",".harmony-suggestive-button"),$(e).on("click",".harmony-suggestive-button",function(e){HarmonyInterop.suggestiveBeatSelection(this)}),$(e).off("click",".file-attachment"),$(e).on("click",".file-attachment",function(e){$(".file-attachment-list").toggleClass("hide"),$(".file-attachment-list").toggleClass("show"),$(".harmony-file-attach").toggleClass("sys-fg-twitter"),$(".pdf-attachment").toggleClass("disable-mouse-events"),$(".image-attachment").toggleClass("disable-mouse-events")}),$(e).off("click",".harmony-add-file-button"),$(e).on("click",".harmony-add-file-button",function(e){HarmonyInterop.uploadFileAttachment(this)}),$(e).off("click",".harmony-added-file"),$(e).on("click",".harmony-added-file",function(e){HarmonyInterop.removeFileAttachment(this)}),$(e).off("click",".image-attachment"),$(e).on("click",".image-attachment",function(e){$(".image-attachment-list").toggleClass("hide"),$(".image-attachment-list").toggleClass("show"),$(".harmony-image-attach").toggleClass("sys-fg-twitter"),$(".pdf-attachment").toggleClass("disable-mouse-events"),$(".file-attachment").toggleClass("disable-mouse-events")}),$(e).off("click",".harmony-add-image-button"),$(e).on("click",".harmony-add-image-button",function(e){HarmonyInterop.uploadImageAttachment(this)}),$(e).off("click",".harmony-added-image"),$(e).on("click",".harmony-added-image",function(e){HarmonyInterop.removeImageAttachment(this)}),$(e).off("click",".pdf-attachment"),$(e).on("click",".pdf-attachment",function(e){$(".pdf-attachment-list").toggleClass("hide"),$(".pdf-attachment-list").toggleClass("show"),$(".harmony-pdf-attach").toggleClass("sys-fg-twitter"),$(".image-attachment").toggleClass("disable-mouse-events"),$(".file-attachment").toggleClass("disable-mouse-events")}),$(e).off("click",".harmony-add-pdf-button"),$(e).on("click",".harmony-add-pdf-button",function(e){HarmonyInterop.uploadPDFAttachment(this)}),$(e).off("click",".harmony-added-pdf"),$(e).on("click",".harmony-added-pdf",function(e){HarmonyInterop.removePDFAttachment(this)}),$(e).off("input",".harmony-trending-search"),$(e).on("input",".harmony-trending-search",function(e){if(!HarmonyInterop.searchInterval){var t=this;HarmonyInterop.searchInterval=!0,setTimeout(function(){HarmonyInterop.searchItemsList(t)},500)}}),$(e).off("input",".harmony-follow-search"),$(e).on("input",".harmony-follow-search",function(e){if(!HarmonyInterop.searchInterval){var t=this;HarmonyInterop.searchInterval=!0,setTimeout(function(){HarmonyInterop.searchItemsList(t)},500)}}),$(e).off("input",".harmony-beats-search"),$(e).on("input",".harmony-beats-search",function(e){if(!HarmonyInterop.searchInterval){var t=this;HarmonyInterop.searchInterval=!0,setTimeout(function(){HarmonyInterop.searchItemsList(t)},500)}}),$(e).off("click",".harmony-search-clear"),$(e).on("click",".harmony-search-clear",function(e){console.log("search - Close");var t=$(this).closest(".harmony-widget");$(t).find(".harmony-search-text").val("");HarmonyInterop.searchItemsList(this)}),$(e).off("click",".harmony-filter-newsfeeds"),$(e).on("click",".harmony-filter-newsfeeds",function(e){HarmonyInterop.postFilterNewsFeeds(this)}),$(e).off("dp.change",".hrm-filter-date-single-parent"),$(e).on("dp.change",".hrm-filter-date-single-parent",function(e){console.log(e.date.format("YYYY-MM-DD"));var t=e.date.format("YYYY-MM-DD"),a=new Date(t).getTime();document.getElementsByClassName("hrm-filter-date-range")[0].noUiSlider.set([a,a]);var r=HarmonyInterop.DateFormat(t).substring(0,10);$(".hrm-filter-date-range")[0].setAttribute("data-slider-endvalue",r),$(".hrm-filter-date-range")[0].setAttribute("data-slider-startvalue",r)})},smartTag:function(e){var t=$(this).closest(".harmony-widget");$(t).find(".follow-item-name");sysproInterop.showSmartTag(e)},imageerrorhandler:function(e){console.log("imageErrorHandler"),"true"!==e.getAttribute("data-imageerror")&&e.getAttribute("data-defaultImage")&&"null"!==e.getAttribute("data-defaultImage")&&"undefined"!==e.getAttribute("data-defaultImage")&&(e.src=e.getAttribute("data-defaultImage"),e.setAttribute("data-imageerror","true"))},getAlias:function(e,t,a,r,n){return console.log("getAlias"),"Contact"===e&&(t=a.split(" ").join("_")),r&&n?e+"."+t+"."+r+"."+n.split(" ").join("_"):r?e+"."+t+"."+r:e+"."+t},GetGeoLocationOfHarmonyBeat:function(e){if(address=new Array,!navigator.geolocation)return"";navigator.geolocation.getCurrentPosition(function(e){var t=e.coords.latitude,a=e.coords.longitude,r=t+";"+a;console.log("GeoLocation:"+ClientGeoLocation);var n="http://maps.googleapis.com/maps/api/geocode/json?latlng="+t+","+a+"&sensor=false";return $.getJSON(n,function(e){HarmonyInterop.Create_Address(e)}).done(function(e){}).fail(function(){}).always(function(){}).complete(function(){}),console.log("HrmClientGeoLocation "+r),console.log("HrmHumanReadableLocation "),r},function(){;"Unable to retrieve your location"})},GetHumanReadableLocation:function(e){if(""==e||null==e)return"";var t=e.split(";");return 2==t.length?(HarmonyInterop.Convert_LatLng_To_Address(t[0],t[1]),address.city?e:address.city):""},Convert_LatLng_To_Address:function(e,t){var a="http://maps.googleapis.com/maps/api/geocode/json?latlng="+e+","+t+"&sensor=false";$.getJSON(a,function(e){HarmonyInterop.Create_Address(e),alert("success")}).done(function(e){alert("second success"+JSON.stringify(e))}).fail(function(){alert("error")}).always(function(){alert("complete")}).complete(function(){alert("second complete")})},Create_Address:function(e){if(!HarmonyInterop.check_status(e))return 0;address.country=HarmonyInterop.google_getCountry(e),address.province=HarmonyInterop.google_getProvince(e),address.city=HarmonyInterop.google_getCity(e),address.street=HarmonyInterop.google_getStreet(e),address.postal_code=HarmonyInterop.google_getPostalCode(e),address.country_code=HarmonyInterop.google_getCountryCode(e),address.formatted_address=HarmonyInterop.google_getAddress(e)},check_status:function(e){return"OK"==e.status},google_getCountry:function(e){return HarmonyInterop.Find_Long_Name_Given_Type("country",e.results[0].address_components,!1)},google_getProvince:function(e){return HarmonyInterop.Find_Long_Name_Given_Type("administrative_area_level_1",e.results[0].address_components,!0)},google_getCity:function(e){return HarmonyInterop.Find_Long_Name_Given_Type("locality",e.results[0].address_components,!1)},google_getStreet:function(e){return HarmonyInterop.Find_Long_Name_Given_Type("street_number",e.results[0].address_components,!1)+" "+Find_Long_Name_Given_Type("route",e.results[0].address_components,!1)},google_getPostalCode:function(e){return HarmonyInterop.Find_Long_Name_Given_Type("postal_code",e.results[0].address_components,!1)},google_getCountryCode:function(e){return HarmonyInterop.Find_Long_Name_Given_Type("country",e.results[0].address_components,!0)},google_getAddress:function(e){return e.results[0].formatted_address},Find_Long_Name_Given_Type:function(e,t,a){var r;for(r in t)if(-1!=t[r].types.indexOf(e))return a?t[r].short_name:t[r].long_name}},HarmonyTrendingChart={renderChartInDiv:function(o,e,t,a,r){var n="SYSPRO_Harmony_Component_TrendingChart";t&&0!==t&&(n="trending-child-layer");var l=$("."+n,o)[0],s={width:1600,height:1600,diameter:1768,labelFontSize:24,class:"SysproChartPack"};d3.select(l).selectAll("svg").remove();var i=d3.select(l).append("svg").attr("width",s.width).attr("height",s.height),d=20,m=+i.attr("width"),c=i.append("g"),y=(d3.scalePow().domain([0,10]).range([.25,.8]),d3.scalePow().domain([-10,0]).range([.85,.25]),d3.scaleSequential(d3.interpolateGreens),d3.scaleSequential(d3.interpolateReds),d3.pack().size([m-d,m-d]).padding(2)),p={name:"Trending",children:e,isRoot:!0};!r&&0!==r||(p.sentiment=r);var g,h=p=d3.hierarchy(p).sum(function(e){return e.size}).sort(function(e,t){return t.name>e.name}),u=y(p).descendants(),f=c.selectAll("circle").data(u).enter().append("circle").attr("class",function(e){return e.parent?e.children?"node":"node node--leaf":"node node--root"}).style("fill",function(e){var t=e.data.sentiment||0;return null===e.parent&&null==r?null:function(e){switch(e){case 0:return"#bfbfbf";case 1:case 2:return"#cce5cc";case 3:case 4:return"#99cc99";case 5:case 6:return"#66b266";case 7:case 8:return"#329932";case 9:case 10:return"#008000";case-1:case-2:return"#ffcccc";case-3:case-4:return"#ff9999";case-5:case-6:return"#ff6666";case-7:case-8:return"#ff3232";case-9:case-10:return"#ff0000";default:return null}}(t)}).on("click",function(n){if(n.data.isRoot)HarmonyInterop.raiseCustomEvent("SYSPRO.Harmony.Search",n.data);else if(h===n||n.data.isRoot)t&&0!==t&&($(".SYSPRO_Harmony_Component_TrendingChart",o).show(),$(".trending-child-layer-parent",o).hide()),d3.select("#myChartBreadcrumb").text(">");else{if(a=a?">"+a:"",d3.select("#myChartBreadcrumb").text(a+">"+(n.data.path?n.data.path:"")),0===n.data.children.length){var e={levelIn:n.data.level,followItemId:n.data.ItemDetail.FollowItemId,linkFollowItemId:n.data.ItemDetail.LinkFollowItemId,keyTable:n.data.ItemDetail.TableName,keyColumn:n.data.ItemDetail.KeyColumn,keyValue:n.data.ItemDetail.KeyValue,followField:n.data.ItemDetail.FollowField,path:n.data.path,IsRoot:!1};sysproInterop.callHarmonyService("GET","Trending/GetTrendingItemsForFollowItem",e,function(e){var t=JSON.parse(e);if(0<t.length){0<$(".trending-child-layer-parent",o).length&&$(".trending-child-layer-parent",o).remove();var a=$(".SYSPRO_Harmony_Component_TrendingChart",o);a.hide();var r=$("<div class='trending-child-layer-parent'><a href='#' class='trending-back-layer'>Back</a><div class='trending-child-layer'></div></div>");a.after(r),$(".trending-back-layer",o).click(function(){$(".SYSPRO_Harmony_Component_TrendingChart",o).show(),$(".trending-child-layer-parent",o).hide()}),HarmonyTrendingChart.renderChartInDiv(o,t,1,n.data.path,n.data.sentiment)}})}HarmonyInterop.raiseCustomEvent("SYSPRO.Harmony.Search",n.data)}h!==n&&(b(n),d3.event.stopPropagation())}),I=v=c.selectAll("text").data(u).enter().append("g"),v=I.append("text").attr("class","label").style("fill-opacity",function(e){return e.parent===p?1:0}).style("display",function(e){return e.parent===p?"inline":"none"}).style("font-size",function(e){return s.labelFontSize+"px"}).text(function(e){return e.data.name}),H=I.append("text").attr("dy","-1em").attr("class","labelgray").style("fill-opacity",function(e){return e.parent===p?1:0}).style("display",function(e){return e.parent===p?"inline":"none"}).style("font-size",function(e){return s.labelFontSize+"px"}).text(function(e){var t="";return e.data.ItemDetail&&(e.data.ItemDetail.FollowField?t=e.data.ItemDetail.KeyColumn+": "+e.data.ItemDetail.KeyValue:e.data.ItemDetail.KeyValue&&(t=e.data.ItemDetail.KeyColumn)),t}),S=c.selectAll("circle,text");function b(e){h=e,d3.transition().duration(750).tween("zoom",function(e){var t=d3.interpolateZoom(g,[h.x,h.y,2*h.r+d]);return function(e){w(t(e))}}).selectAll("text").style("fill-opacity",function(e){return null==e||null==e?0:e===p?0:e===h&&void 0===e.children?1:e.parent===h?1:0}).on("start",function(e){null!=e&&void 0!==e&&(e.parent===h&&(this.style.display="inline"),e===h&&void 0===e.children&&(this.style.display="inline"))}).on("end",function(e){null!=e&&void 0!==e&&(e.parent!==h&&(this.style.display="none"),e===h&&void 0===e.children&&(this.style.display="inline"))})}function w(t){var o=m/t[2];g=t;var e=l.clientWidth;i.attr("width",e),i.attr("height",e);var a=e/s.width;c.attr("transform","matrix("+a+", 0, 0, "+a+", "+a*m/2+", "+a*m/2+")"),S.attr("transform",function(e){return"matrix(1, 0, 0, 1, "+(e.x-t[0])*o+","+(e.y-t[1])*o+")"}),f.attr("r",function(e){return e.r*o}),v.style("font-size",function(e){var t=this.getBBox(),a=this.style.fontSize||s.labelFontSize+"px";a=+(""+a).replace("px","");var r=(2*e.r*o*a+d)/Math.max(t.width,0*t.height);return(r=r===1/0?1:(2*e.r-2)*r/(2*e.r))+"px"}).attr("dy","0.33em"),H.style("font-size",function(e){var t=null;e.data.name.length>this.textContent.length&&(t=this.textContent,this.textContent=e.data.name);var a=this.getBBox(),r=this.style.fontSize||s.labelFontSize+"px";r=+(""+r).replace("px","");var n=(2*e.r*o*r+d)/Math.max(a.width,0*a.height);return n=n===1/0?1:(2*e.r-4)*n/(2*e.r),n*=.8,null!==t&&(this.textContent=t),n+"px"}).attr("dy",function(e){this.getBBox();return"-1em"})}i.on("click",function(){b(p)}),w([p.x,p.y,2*p.r+d]),l&&new ResizeSensor(l,function(){h&&b(h)})},bindTrendingDrillDown:function(){window.addEventListener("SYSPRO.Harmony.Search",function(r){var n={};if(null==r.detail||r.detail.isRoot){n.data={},n.data.detail=r.detail;var e=kendo.observable(n);return kendo.bind($("#trendingDetail"),e),kendo.bind($("#trendingDetailKeyInfo"),e),void $("#trendingDetailPieChart").hide()}var t={keyTable:r.detail.ItemDetail.TableName,keyColumn:r.detail.ItemDetail.KeyColumn,keyValue:r.detail.ItemDetail.KeyValue};sysproInterop.callHarmonyService("GET","Trending/GetTrendingItemKeyInfo",t,function(e){n.data={},n.data.detail=r.detail,n.data.columns=JSON.parse(e);var t=function(e){var t=null,a=null,r=null,n=null,o=[],l=0;return e.children.forEach(function(e){l+=parseInt(e.size)}),console.log("totalBeatCount - "+l),e.children.forEach(function(e){o.push({category:e.name,value:e.size,percentage:kendo.toString(parseInt(e.size)/l,"p")}),(null==r||e.size>r.size)&&(r=e)}),null!=r&&(t=r),null!=n&&(a=n.name),{trendingChild:t,trendingSubTopic:a,pieChartSeries:o}}(r.detail);n.data.trendingChild=t.trendingChild,n.data.trendingSubTopic=t.trendingSubTopic,n.data.series=t.pieChartSeries;var a=kendo.observable(n);kendo.bind($("#trendingDetail"),a),kendo.bind($("#trendingDetailKeyInfo"),a),n.data.series.length?($("#trendingDetailPieChart").show(),$("#trendingDetailPieChart").kendoChart({theme:"bootstrap",visible:!0,legend:{visible:!1,position:"top"},series:[{type:"pie",overlay:{gradient:"none"},data:n.data.series}],tooltip:{visible:!0,template:"#= dataItem.category # - #= dataItem.percentage # (#= dataItem.value # beats)"},chartArea:{height:140,width:140}})):$("#trendingDetailPieChart").hide()})}),window.addEventListener("SYSPRO.Harmony.TrendingDrilldown",function(e){if(console.log("SYSPRO.Harmony.TrendingDrilldown"),0<$("#Beats").length){var r=$("#Beats").closest(".harmony-widget"),t=e.detail;sysproInterop.callHarmonyService("GET","Trending/GetDrilldownBeats",t,function(e){var t=JSON.parse(e);$.each(t.Beats,function(e){this.Feed=ProcessFeedHtml(this.Feed,this.FollowItems)}),$(".ShowMoreNewsFeeds").remove();var a=kendo.observable(t);kendo.bind(r,a)})}})},clickTrendingDrillDown:function(e){var t=$(e).closest(".trending-drilldown-metadata"),a={levelIn:t.data("levelid"),followItemId:t.data("followitemid"),linkFollowItemId:t.data("linkfollowitemid"),keyTable:t.data("keytable"),keyColumn:t.data("keycolumn"),keyValue:t.data("keyvalue"),followField:t.data("followfield"),path:""};HarmonyInterop.raiseCustomEvent("SYSPRO.Harmony.TrendingDrilldown",a)}},AliasUser=[],AliasFullValue=null,selectedItems=[],replacementsMade=[],UserInput=!0;function UpdateSelectionList(e,t){try{var a;return console.log("UpdateSelectionList item - "+JSON.stringify(e)),console.log("UpdateSelectionList AliasValue - "+JSON.stringify(AliasFullValue)),AliasFullValue?(AliasFullValue.Key?a=HarmonyInterop.getAlias(AliasFullValue.Type,AliasFullValue.DataField1,AliasFullValue.Key,""):AliasFullValue.Type&&(a=HarmonyInterop.getAlias(AliasFullValue.Type,AliasFullValue.DataField1,AliasFullValue.Key,"")),e.Type&&(a=e.Key?HarmonyInterop.getAlias(AliasFullValue.Type,AliasFullValue.DataField1,AliasFullValue.Key,e.Type,e.Key):HarmonyInterop.getAlias(AliasFullValue.Type,AliasFullValue.DataField1,AliasFullValue.Key,e.Type)),AddSelectedItem(t,"#"+a,AliasFullValue.DataField3,AliasFullValue.Type,e.Type,AliasFullValue.DataField1,"",e.Key)):(e.Type&&(a=e.Key?HarmonyInterop.getAlias(HarmonyInterop.categorySelected,HarmonyInterop.fieldSelected,e.Key,e.Type,e.Key):HarmonyInterop.getAlias(HarmonyInterop.categorySelected,HarmonyInterop.fieldSelected,"",e.Type)),AddSelectedItem(t,"#"+a,HarmonyInterop.tableSelected,HarmonyInterop.categorySelected,e.Type,HarmonyInterop.fieldSelected,"",e.Key)),a}catch(e){SYSPRO_VB.showErrorMessage("UpdateSelectionList error : "+e.message)}}function CategoryFIELD_Template(e){return"<div class='text-complete sys-200 sys-txt-sm sys-mg-off sys-pd-off'> "+e.Type+" : "+e.Key+"</div>"}function Category_Template(e){return"Contact"===e.Type?'<div><img src="'+e.DataField2+'" style="width:25px; height:25px; display:inline-block; border-radius: 50%;"></img><span class="text-complete sys-pd-off">  '+e.Key+"</span></div>":'<div class="text-complete sys-pd-off">'+e.Key+"<br><div class='sys-200 sys-txt-md'> Title: "+e.DataField1+"</div></div>"}function HistoryNew_Template(e){return'<div class="text-complete sys-txt-md sys-pd-off">'+e.Key+"</div>"}function Alias_Template(e){return'<div class="text-complete sys-pd-off" >'+e.Key+"</div>"}function user_Template(e){return"Y"===e.DataField3?'<div class="text-complete sys-pd-off sys-pd-off"><img src="'+e.DataField2+'" style="width:25px; height:25px; display:inline-block; border-radius: 50%;"></img><small> '+e.DataField1+"</small><br><small>Name : "+e.Key+"</small></div>":'<div class="text-complete sys-pd-off sys-pd-off"><img src="'+e.DataField2+'" style="width:25px; height:25px; display:inline-block; border-radius: 50%;"></img><small> '+e.DataField1+"</small><br><small>Name : "+e.Key+'</small><br><small  style="font-style: italic">Offline</small></div></div>'}function User_Alias_Template(e){return"Y"===e.DataField3?'<div  class="text-complete sys-pd-off sys-pd-off"><img src="'+e.DataField2+'" style="width:25px; height:25px; display:inline-block; border-radius: 50%;"></img><small style="font-style: italic"> '+e.DataField1+'</small><br><small style="font-style: italic">Name : '+e.Key+"</small></div>":'<div class="text-complete sys-pd-off sys-pd-off"><img src="'+e.DataField2+'" style="width:25px; height:25px; display:inline-block; border-radius: 50%;"></img><small style="font-style: italic"> '+e.DataField1+'</small><br><small style="font-style: italic">Name : '+e.Key+'</small><br><small style="font-style: italic">Offline</small></div>'}function ProcessMissingTags(l){if(UserInput){var s=l.html();if(0==HarmonyInterop.AliasValue.length&&0==HarmonyInterop.AliasType.length&&0==AliasUser.length){BeatText=l.text();var e=BeatText.match(/#(\w*)([^\w.*]$)/g),o=BeatText.match(/@(\w*)$\w*\s([^\w*]$)/g),t=BeatText.match(/#(\w*\b\.*(\S[^\.\s]*))([^\w.*]$)/g);e?$.each(e,function(e){var t=this.toString();console.log("!AliasType : "+t);var a=t.match(/#(\S*)\w/g);if(null!=a){var r=a.toString(),n=GenerateHtmlBlockFromHashAlias(r=r.replace("#","").trim(),r,null,null,null,!0,null,selectedItems.length);AddReplacementsMadeItem("#"+r,n),AddSelectedItem(l,"#"+r,"UserDefined",r,"","","",""),UserInput=!1,l.html(s.replace(a.toString(),n)),UserInput=!0,s=l.html()}HarmonyInterop.AliasValue=[],HarmonyInterop.AliasType=[],HarmonyInterop.tableSelected=""}):t&&console.log("AliasValue not set"),o&&$.each(o,function(e){var n=SanitiseBeatText(this);if(n=n.replace(/\W$/g,""),console.log(n+"- @"+o.Key),"@"+o.Key!=n.trim()&&(console.log("no usertype match found : @"+o.Key+" "+n.trim()),HarmonyInterop.typingInterval||(HarmonyInterop.typingInterval=!0,sysproInterop.callHarmonyService("GET","AutoComplete/GetUserList",{QueryValue:n},function(e){try{HarmonyInterop.typingInterval=!1;var t=JSON.parse(e);if(null!=t[0].Key?o.Key=t[0].Key:o.Key=a,void 0===o.Key){var a=n.substring(1);o.Key=a}if(""!=o.Key){console.log("!!!!!!!!!!!MATCHTYPE - "+o.Key+" "+this);var r=GenerateHtmlBlockFromHashAlias(o.Key,o.Key,null,null,null,!0,null,selectedItems.length);AddReplacementsMadeItem("@"+o.Key,r),AddSelectedItem(l,"@"+o.Key,"HrmUser","UserId","","","",""),UserInput=!1,l.html(s.replace(o[0].trim(),r)),UserInput=!0,s=l.html(),AliasUser=[],HarmonyInterop.AliasValue=[],HarmonyInterop.AliasType=[],HarmonyInterop.tableSelected=""}}catch(e){HarmonyInterop.typingInterval=!1,SYSPRO_VB.showErrorMessage(e.message,"Error Calling Harmony Service ")}}))),""!=o.Key){console.log("!!!!!!!!!!!MATCHTYPE - "+o.Key+" "+n.replace("@","").trim());var t=GenerateHtmlBlockFromHashAlias(o.Key,o.Key,null,null,null,!0,null,selectedItems.length);if(0<replacementsMade.length)0<$.inArray("@"+o.Key,replacementsMade)&&replacementsMade.push({Alias:"@"+o.Key,Html:t.split("'").join('"')});else replacementsMade.push({Alias:"@"+o.Key,Html:t.split("'").join('"')});AddSelectedItem(l,"@"+o.Key,"HrmUser","UserId","","","",""),UserInput=!1,l.html(s.replace("@"+o.Key,t)),UserInput=!0,s=l.html(),HarmonyInterop.AliasValue=[],HarmonyInterop.AliasType=[],HarmonyInterop.tableSelected=""}})}if(0<HarmonyInterop.AliasValue.length){BeatText=l.text();var a=BeatText.match(/#(\w*\b\.*(\S[^\.\s]*))([^\w.*]$)/g);a&&$.each(a,function(e){var t=SanitiseBeatText(this);t=t.replace(/\W$/g,"");var a=HarmonyInterop.getAlias(HarmonyInterop.AliasValue[0].Type,HarmonyInterop.AliasValue[0].DataField1,HarmonyInterop.AliasValue[0].Key,""),r=HarmonyInterop.getAlias(HarmonyInterop.AliasValue[0].Type,HarmonyInterop.AliasValue[0].DataField1,HarmonyInterop.AliasValue[0].Key,"");if("#"+a==t.trim()){var n=GenerateHtmlBlockFromHashAlias(r,HarmonyInterop.AliasType[0].DataField1,HarmonyInterop.AliasValue[0].DataField1,null,HarmonyInterop.AliasValue[0].Key,!0,"",selectedItems.length);AddReplacementsMadeItem("#"+r,n),AddSelectedItem(l,"#"+r,HarmonyInterop.AliasValue[0].DataField3,HarmonyInterop.AliasType[0].DataField1,"",HarmonyInterop.AliasValue[0].DataField1,"",HarmonyInterop.AliasValue[0].DataField1),UserInput=!1,l.html(s.replace(t.trim(),n)),UserInput=!0,s=l.html(),HarmonyInterop.AliasValue=[],HarmonyInterop.AliasType=[],HarmonyInterop.tableSelected=""}})}if(0<HarmonyInterop.AliasType.length){BeatText=l.text();e=BeatText.match(/#(\w*)([^\w.*]$)/g),t=BeatText.match(/#(\w*\b\.*(\S[^\.\s]*))([^\w.*]$)/g);e?$.each(e,function(e){var t=SanitiseBeatText(this);t=t.replace(/\W$/g,"");HarmonyInterop.AliasType[0].DataField1;if(t=="#"+HarmonyInterop.AliasType[0].Key){var a=GenerateHtmlBlockFromHashAlias(HarmonyInterop.AliasType[0].DataField1,HarmonyInterop.AliasType[0].DataField1,null,null,null,!0,null,selectedItems.length);AddReplacementsMadeItem("#"+HarmonyInterop.AliasType[0].DataField1,a),AddSelectedItem(l,"#"+HarmonyInterop.AliasType[0].DataField1,HarmonyInterop.AliasType[0].DataField2,HarmonyInterop.AliasType[0].DataField1,"","","",""),UserInput=!1,l.html(s.replace(t,a)),UserInput=!0,s=l.html(),HarmonyInterop.AliasValue=[],HarmonyInterop.AliasType=[],HarmonyInterop.tableSelected=""}}):t&&$.each(t,function(e){var n,o,t=this.toString(),a=t.match(/#(\S*)\w($[$\s])/g);o=a?(n=a[0].toString().trim(),a[0].toString().trim()):(n=t.trim(),t.trim()),n=(n=n.replace("#","")).split("."),""!=HarmonyInterop.tableSelected&&""!=HarmonyInterop.categorySelected&&""!=n[1]&&(HarmonyInterop.typingInterval||(HarmonyInterop.typingInterval=!0,sysproInterop.callHarmonyService("GET","AutoComplete/GetKeyFieldValue",{RootName:HarmonyInterop.tableSelected,KeyColumnName:HarmonyInterop.categorySelected,KeyFieldValue:n[1]},function(e){try{HarmonyInterop.typingInterval=!1;var t=JSON.parse(e);if(null!=t.DataField1){HarmonyInterop.fieldSelected=t.DataField1,HarmonyInterop.tableSelected=t.DataField3,HarmonyInterop.categorySelected=t.Type;HarmonyInterop.fieldSelected,HarmonyInterop.tableSelected,HarmonyInterop.categorySelected}else{HarmonyInterop.fieldSelected=n[1],HarmonyInterop.categorySelected=n[0];HarmonyInterop.fieldSelected,HarmonyInterop.tableSelected,HarmonyInterop.categorySelected}var a="#"+HarmonyInterop.categorySelected+"."+HarmonyInterop.fieldSelected,r=GenerateHtmlBlockFromHashAlias(HarmonyInterop.categorySelected+"."+HarmonyInterop.fieldSelected,HarmonyInterop.categorySelected,HarmonyInterop.fieldSelected,null,null,!0,"",selectedItems.length);AddReplacementsMadeItem(a,r),AddSelectedItem(l,a,HarmonyInterop.tableSelected,a,"","","",""),UserInput=!1,l.html(s.replace(o,r)),UserInput=!0,s=l.html(),HarmonyInterop.AliasValue=[],HarmonyInterop.AliasType=[],HarmonyInterop.tableSelected="",HarmonyInterop.fieldSelected="",HarmonyInterop.categorySelected=""}catch(e){HarmonyInterop.typingInterval=!1,SYSPRO_VB.showErrorMessage(e.message,"Error Calling Harmony Service ")}})))})}if(void 0!==AliasUser)BeatText=l.text(),(o=BeatText.match(/@(\w*)([^\w*]$)/g))&&$.each(o,function(e){var n=SanitiseBeatText(this);if(n=n.replace(/\W$/g,""),"@"+o.Key!=n.trim()){if(console.log("no usertype match found : @"+o.Key+" "+this),!HarmonyInterop.typingInterval){HarmonyInterop.typingInterval=!0;var t=n.substring(1);sysproInterop.callHarmonyService("GET","AutoComplete/GetUserList",{QueryValue:t},function(e){try{HarmonyInterop.typingInterval=!1;var t=JSON.parse(e);if(null!=t[0].Key?o.Key=t[0].Key:o.Key=a,void 0===o.Key){var a=n.substring(1);o.Key=a}if(""!=o.Key){console.log("!!!!!!!!!!!MATCHTYPE - "+o.Key+" "+this);var r=GenerateHtmlBlockFromHashAlias(o.Key,o.Key,null,null,null,!0,null,selectedItems.length);AddReplacementsMadeItem("@"+o.Key,r),AddSelectedItem(l,"@"+o.Key,"HrmUser","UserId","","","",""),UserInput=!1,l.html(s.replace(o[0].trim(),r)),UserInput=!0,s=l.html(),AliasUser=[],HarmonyInterop.AliasValue=[],HarmonyInterop.AliasType=[],HarmonyInterop.tableSelected=""}}catch(e){HarmonyInterop.typingInterval=!1,SYSPRO_VB.showErrorMessage(e.message,"Error Calling Harmony Service ")}})}console.log(o.Key)}})}}function setEndOfContenteditable(e){var t,a;alert("setEndOfContenteditable"),document.createRange?((t=document.createRange()).selectNodeContents(e),t.collapse(!1),(a=window.getSelection()).removeAllRanges(),a.addRange(t)):document.selection&&((t=document.body.createTextRange()).moveToElementText(e),t.collapse(!1),t.select())}function FindFollowItem(e,t){var a=null;return $.each(e,function(e){this.Alias===t&&(a=this)}),a}function ProcessFeedHtml(l,s){var e=l.match(/(\#\w*\.\S*\.\S*\w|$)/g),t=l.match(/(\B#\w*\b\.*(\S[^\.\s]*)\.*(\S[^\.\s]*)|$)/g),a=l.match(/#(\w*?)\.(\w*?)(?=[^\w\.]|$)/g),r=l.match(/#(\w*?)(?=[^\w\.]|$)/g),n=l.match(/@(\w*?)(?=[^\w\.]|$)/g);return e&&$.each(e,function(e){var t=this+"",a=FindFollowItem(s,t);if(a){var r=t.substring(1),n=(t.substring(1,t.indexOf(".")),t.substring(t.indexOf(".")+1,t.lastIndexOf(".")),t.indexOf(" "));-1===n&&(n=t.length);t.substring(t.lastIndexOf(".")+1,n);var o=GenerateHtmlBlockFromHashAlias(r,a.KeyColumn,a.KeyValue,a.FollowField,a.CurrentValue,!1,a.FollowItemId,null,a.KeyDescription);l=l.replace(this+"",o)}}),t&&$.each(t,function(e){var t=this+"",a=FindFollowItem(s,t);if(a){var r=t.substring(1),n=(t.substring(1,t.indexOf(".")),t.substring(t.indexOf(".")+1,t.lastIndexOf(".")),t.indexOf(" "));-1===n&&(n=t.length);t.substring(t.lastIndexOf(".")+1,n);var o=GenerateHtmlBlockFromHashAlias(r,a.KeyColumn,a.KeyValue,a.FollowField,a.CurrentValue,!1,a.FollowItemId,null,a.KeyDescription);l=l.replace(this+"",o)}}),a&&$.each(a,function(e){var t=this.toString().match(/#(\S*)\w|$[$\s]/g)[0].toString()+"",a=t.substring(1),r=FindFollowItem(s,t);if(r){t.substring(1,t.indexOf("."));var n=t.indexOf(" ");-1===n&&(n=t.length);t.substring(t.indexOf(".")+1,n);var o=GenerateHtmlBlockFromHashAlias(a,r.KeyColumn,r.KeyValue,r.FollowField,r.CurrentValue,!1,r.FollowItemId,null,r.KeyDescription);l=l.replace(this+"",o)}}),r&&$.each(r,function(e){var t=this+"",a=FindFollowItem(s,t);if(a){var r=t.substring(1),n=GenerateHtmlBlockFromHashAlias(r,a.KeyColumn,a.KeyValue,a.FollowField,a.CurrentValue,!1,a.FollowItemId,null,a.KeyDescription);l=l.replace(this+"",n)}}),n&&$.each(n,function(e){var t=this+"",a=FindFollowItem(s,t);if(a){var r=t.substring(1),n=GenerateHtmlBlockFromHashAlias(r,r,null,null,null,!1,a.FollowItemId);l=l.replace(this+"",n)}}),l}function GenerateHtmlBlockFromHashAlias(e,t,a,r,n,o,l,s,i){var d=!1,m="";o&&(m="<i class='material-icons sys-txt-xs pull-right' style='color:rgba(51,51,51); margin-bottom: 8px;' onclick='HarmonyInterop.removeTextCompleteWord(this)'>close</i>");var c="",y="",p="<span contenteditable='false' class='text-muted sys-txt-md' data-followitemid='"+l+"'>";if(r&&(c=m+"<span contenteditable='false' class='text-muted sys-txt-md sys-mg-t-2' ></br>"+r+": "+n,d=!0),"Contact"==t){var g,h=t.replace(/([A-Z])/g," $1").trim().toLowerCase(),u=e.split(".");g=1<u.length?u[1]:"",y=d?"<a style='background-color: aliceblue !important; text-decoration: none !important; border-bottom-color: rgb(0,120,215); border-bottom-width: thin; border-bottom-style: solid;' onclick='sysproInterop.showSmartTag(this)' data-fieldcaption='ESPRESSOKEYFIELD:"+h+"' data-fieldvalue='"+a+"'><span contenteditable='false' class='sys-500 text-muted' >"+t+":  "+g+"</a>":"<a style='background-color: aliceblue !important; text-decoration: none !important; border-bottom-color: rgb(0,120,215); border-bottom-width: thin; border-bottom-style: solid;' onclick='sysproInterop.showSmartTag(this)' data-fieldcaption='ESPRESSOKEYFIELD:"+h+"' data-fieldvalue='"+a+"'><span contenteditable='false' class='sys-500 text-muted' >"+t+":  "+g+m+"</a>"}else if(a){h=t.replace(/([A-Z])/g," $1").trim().toLowerCase();y=i?d?"<a style='background-color: aliceblue !important; text-decoration: none !important; border-bottom-color: rgb(0,120,215); border-bottom-width: thin; border-bottom-style: solid;' onclick='sysproInterop.showSmartTag(this)' data-fieldcaption='ESPRESSOKEYFIELD:"+h+"' data-fieldvalue='"+a+"'><span contenteditable='false' class='sys-500 text-muted' >"+t+":  "+a+" - "+i+"</a>":"<a style='background-color: aliceblue !important; text-decoration: none !important; border-bottom-color: rgb(0,120,215); border-bottom-width: thin; border-bottom-style: solid;' onclick='sysproInterop.showSmartTag(this)' data-fieldcaption='ESPRESSOKEYFIELD:"+h+"' data-fieldvalue='"+a+"'><span contenteditable='false' class='sys-500 text-muted' >"+t+":  "+a+" - "+i+m+"</a>":d?"<a style='background-color: aliceblue !important; text-decoration: none !important; border-bottom-color: rgb(0,120,215); border-bottom-width: thin; border-bottom-style: solid;' onclick='sysproInterop.showSmartTag(this)' data-fieldcaption='ESPRESSOKEYFIELD:"+h+"' data-fieldvalue='"+a+"'><span contenteditable='false' class='sys-500 text-muted' >"+t+":  "+a+"</a>":"<a style='background-color: aliceblue !important; text-decoration: none !important; border-bottom-color: rgb(0,120,215); border-bottom-width: thin; border-bottom-style: solid;' onclick='sysproInterop.showSmartTag(this)' data-fieldcaption='ESPRESSOKEYFIELD:"+h+"' data-fieldvalue='"+a+"'><span contenteditable='false' class='sys-500 text-muted' >"+t+":  "+a+m+"</a>"}else y=t?d?"<span contenteditable='false' class='sys-500 text-muted'>"+t:"<span contenteditable='false' class='sys-500 text-muted'>"+t+m:"<span contenteditable='false' class='sys-500 text-muted' >"+e;return p="<div class='alias-"+e+" harmony-text-complete hrm-key-field-template' contenteditable='false' data-identifier="+s+">"+p+y+c+"</span></span></div>"}function SanitiseBeatText(e){return $("<div>"+e+"</div>").text()}function AddReplacementsMadeItem(e,t){-1==e.indexOf("undefined")&&replacementsMade.push({Alias:e,Html:t.split("'").join('"')})}function AddSelectedItem(e,t,a,r,n,o,l,s){if(-1==t.indexOf("undefined")){if(0<selectedItems.length)0==$.grep(selectedItems,function(e){return e.Alias==t}).length&&selectedItems.push({Index:e.prop("selectionStart"),Alias:t,TableName:a,KeyColumn:r,FollowField:n,KeyValue:o,Context:l,CurrentValue:s,Identifier:selectedItems.length});else selectedItems.push({Index:e.prop("selectionStart"),Alias:t,TableName:a,KeyColumn:r,FollowField:n,KeyValue:o,Context:l,CurrentValue:s,Identifier:0});HarmonyInterop.AliasValue=[],HarmonyInterop.AliasType=[],HarmonyInterop.tableSelected=""}}function PostBeatClicked(e){try{console.log("PostBeatClicked - "+e);var t=e,a=t.html(),r=(a=a.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"')).replace(/\s+/g,"");if(!((r=r.replace(/&nbsp;/g,"")).trim().length<=0)){var n="";if(n=a,0<HarmonyInterop.AliasType.length||0<HarmonyInterop.AliasValue.length){if(0<HarmonyInterop.AliasType.length){var o=GenerateHtmlBlockFromHashAlias(HarmonyInterop.AliasType[0].DataField1,HarmonyInterop.AliasType[0].DataField1,null,null,null,!0,null,selectedItems.length);AddReplacementsMadeItem("#"+HarmonyInterop.AliasType[0].DataField1,o),AddSelectedItem($(".harmony-beat-entry",e),"#"+HarmonyInterop.AliasType[0].DataField1,HarmonyInterop.AliasType[0].DataField3,HarmonyInterop.AliasType[0].DataField1,"","","","")}if(0<HarmonyInterop.AliasValue.length){var l=HarmonyInterop.getAlias(HarmonyInterop.AliasValue[0].Type,HarmonyInterop.AliasValue[0].DataField1,HarmonyInterop.AliasValue[0].Key,"");AddReplacementsMadeItem("#"+l,o=GenerateHtmlBlockFromHashAlias(l,HarmonyInterop.AliasValue[0].Type,HarmonyInterop.AliasValue[0].DataField1,null,null,!0,"",selectedItems.length)),AddSelectedItem($(".harmony-beat-entry",e),"#"+l,HarmonyInterop.AliasValue[0].DataField3,HarmonyInterop.AliasValue[0].Type,"",HarmonyInterop.AliasValue[0].DataField1,"",HarmonyInterop.AliasValue[0].DataField1)}}replacementsMade&&$.each(replacementsMade,function(e){console.log("replacementsMade - "+this.Alias+" - "+this.Html);var t=n.indexOf('<div class="alias-'+this.Alias.substring(1));if(-1<t){var a=n.substring(t,n.indexOf("</div>",t)+6);console.log("toReplace - "+a),n=n.replace(a,this.Alias)}}),n=SanitiseBeatText(n);var s="Post Beat clicked: "+a,i=[],d=[];if(i=n.match(/#(\S*)\w|$[$\s]/g),selectedItems=selectedItems||[],$.each(selectedItems,function(e){if(""==selectedItems[e].TableName&&(selectedItems[e].TableName="UserDefined"),0<=selectedItems[e].KeyColumn.indexOf(".")&&""==selectedItems[e].KeyValue){var t=selectedItems[e].KeyColumn.indexOf(".");selectedItems[e].KeyValue=selectedItems[e].KeyColumn.substring(t+1),0<=selectedItems[e].KeyColumn.indexOf("#")&&(selectedItems[e].KeyColumn=selectedItems[e].KeyColumn.substring(1,t))}d.push(selectedItems[e])}),null!==(i=i||[]).length||0!==selectedItems.length)for(var m=0;m<i.length;m++){for(var c=!1,y=0;y<selectedItems.length;y++)console.log("taggedWords - "+i[m]+","+selectedItems[y].Alias),i[m]===selectedItems[y].Alias&&(c=c||!0);if(!1===c){var p,g,h=i[m].replace("#",""),u=h.indexOf(".");0<h.indexOf(".")?(g=h.substring(0,u),p=h.substring(u+1)):(p="",g=h),d.push({Index:m,Alias:i[m],TableName:"UserDefined",KeyColumn:g,FollowField:"",KeyValue:p,Context:"",CurrentValue:""})}}for(var f=0;f<d.length;f++)s+=0===f?" Trending fields : "+d[f]:", "+d[f];HarmonyInterop.PostBeat(t,n,d),HarmonyInterop.AliasValue=[],HarmonyInterop.AliasType=[],HarmonyInterop.tableSelected=""}}catch(e){SYSPRO_VB.showErrorMessage("error when posting a beat! "+e.message)}}function AdmiredClicked(){try{var e=$(event.target).closest("[data-beatid]").attr("data-beatid"),t=$(event.target).closest("[data-userid]").attr("data-userid"),a=$(event.target).hasClass("btn-default"),r=$(event.target).children("span").text();r=parseInt($(event.target).children("span").text()),a?(HarmonyInterop.AdmireBeat(e,t),r++,$(event.target).addClass("btn-admired").removeClass("btn-default"),$(event.target).children("span").text(r),$(event.target).children("span").addClass("text-admired").removeClass("text-muted"),$(event.target).children("i").text("favorite")):(HarmonyInterop.UnAdmireBeat(e,t),r--,$(event.target).addClass("btn-default").removeClass("btn-admired"),$(event.target).children("span").text(r),$(event.target).children("span").addClass("text-muted").removeClass("text-admired"),$(event.target).children("i").text("favorite_border"))}catch(e){alert(e.message)}}function RebeatClicked(){try{var e=$(event.target).closest("[data-beatid]").attr("data-beatid");console.log($(event.target).children("span"));var t=$(event.target).children("span").text();t=$(event.target).find("span").text(),0==(t=parseInt($(event.target).children("span").text()))&&(HarmonyInterop.Rebeat(e),t++,$(event.target).children("span").text(t),$(event.target).addClass("btn-rebeat").removeClass("btn-default"),$(event.target).closest("span").addClass("text-rebeat").removeClass("text-muted"))}catch(e){SYSPRO_VB.showErrorMessage("error on Rebeat! "+e.message)}}function getGeoLocationOfBeat(){if(!navigator.geolocation)return"";navigator.geolocation.getCurrentPosition(function(e){var t=e.coords.latitude,a=e.coords.longitude;return ClientGeoLocation=t+";"+a,console.log("GeoLocation:"+ClientGeoLocation),GetPlaceFromLatLng(ClientGeoLocation),ClientGeoLocation},function(){;"Unable to retrieve your location"})}function prompt(e,t,a,r){return r(!0)}function GetPlaceFromLatLng(e){if(""==e||null==e)return"";var t=e.split(";");return 2==t.length?(Convert_LatLng_To_Address(t[0],t[1]),address.city?e:address.city):""}function Convert_LatLng_To_Address(e,t,a){var r="http://maps.googleapis.com/maps/api/geocode/json?latlng="+e+","+t+"&sensor=false";jQuery.getJSON(r,function(e){Create_Address(e,a),a()})}function Create_Address(e,t){if(!check_status(e))return 0;address.country=google_getCountry(e),address.province=google_getProvince(e),address.city=google_getCity(e),address.street=google_getStreet(e),address.postal_code=google_getPostalCode(e),address.country_code=google_getCountryCode(e),address.formatted_address=google_getAddress(e),t()}function check_status(e){return"OK"==e.status}function google_getCountry(e){return Find_Long_Name_Given_Type("country",e.results[0].address_components,!1)}function google_getProvince(e){return Find_Long_Name_Given_Type("administrative_area_level_1",e.results[0].address_components,!0)}function google_getCity(e){return Find_Long_Name_Given_Type("locality",e.results[0].address_components,!1)}function google_getStreet(e){return Find_Long_Name_Given_Type("street_number",e.results[0].address_components,!1)+" "+Find_Long_Name_Given_Type("route",e.results[0].address_components,!1)}function google_getPostalCode(e){return Find_Long_Name_Given_Type("postal_code",e.results[0].address_components,!1)}function google_getCountryCode(e){return Find_Long_Name_Given_Type("country",e.results[0].address_components,!0)}function google_getAddress(e){return e.results[0].formatted_address}function Find_Long_Name_Given_Type(e,t,a){var r;for(r in t)if(-1!=t[r].types.indexOf(e))return a?t[r].short_name:t[r].long_name}function ComposeReplyToBeat(e){try{if(0<$("#Harmony-Reply-Template").length){$(".HarmonyReplies").remove(),$(".HrmBeatItem").show();var t=kendo.template($("#Harmony-Reply-Template").html()),a=$(event.target).closest("[data-beatid]"),r=a.attr("data-beatid");console.log("01 ComposeReplyToBeat");var n=t({User:a.attr("data-user"),Url:a.attr("data-Url"),TimeAgo:a.attr("data-TimeAgo"),Location:a.attr("data-Location"),Sentiment:a.attr("data-Sentiment"),Feed:a.attr("data-Feed"),BeatId:a.attr("data-beatid"),Media:a.attr("data-Media"),NumberOfAttachments:a.attr("data-NumberOfAttachments")});console.log("02 ComposeReplyToBeat");var o=a.prepend(n);a.children().show(),HarmonyInterop.initializeAutoComplete(o,r),HarmonyInterop.InitializeAttachments(),0<$("#feed").length&&$("#feed").carousel("pause");var l=a.find(".HrmBeatItem");l.is(":visible")?$(l).hide():$(l).show(),a.find(".hrm-key-field-template").addClass("hrm-key-field-template-reply"),sysproInterop.callHarmonyService("GET","NewsFeeds/GetFollowItemReplies",{ParentBeatId:r},function(e){try{var r=JSON.parse(e),n="";null==r.Beats&&$.each(r.Beats,function(e){this.Feed=ProcessFeedHtml(this.Feed,this.FollowItems)});kendo.observable(r);$.each(r.Beats,function(e,t){var a=kendo.template($("#beats_template").html())(r.Beats[e]);a=(a=(a=(a=a.split("beat-border").join("")).split("reply-border").join("beat-reply-border")).split("col-xs-3").join("col-xs-6")).split("col-sm-3").join("col-sm-6"),n+=a,$("#example").html(n),$(".hrm-reply-to-remove","#example").remove()})}catch(e){SYSPRO_VB.showErrorMessage(e.message,"Error on GetFollowItemReplies")}},function(e){SYSPRO_VB.showErrorMessage(e.ErrorMessage,"Error Calling Harmony Service")})}else sysproInterop.showErrorMessage("'Reply to beat' component is needed to reply to a beat.  Please add the missing component to use this functionality.","Missing component")}catch(e){SYSPRO_VB.showErrorMessage("error on Rebeat! "+e.message)}}